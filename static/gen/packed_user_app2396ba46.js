function apiUrl(path){return api_url_me+path}
function siteUrl(path){return path}
function baseSiteUrl(path){return base_url+path}
function fitImageIn(image,container){image.hide();container.css({'position':'relative'})
function onload(){var maxX=container.outerWidth();var maxY=container.outerHeight();var imgW=image.width();var imgH=image.height();var imgRatio=1;var boxRatio=1;imgRatio=(imgW<imgH)?imgH/imgW:imgW/imgH;var newW=imgRatio*imgW*boxRatio;var newH=imgRatio*imgH*boxRatio
if(newW<=newH&&newW>maxX)
boxRatio=maxX/newW
else if(newH<=newW&&newH>maxY)
boxRatio=maxY/newH
var rW=newW*boxRatio
var rH=newH*boxRatio
image.height(rH);image.width(rW);var t=0,l=0;if(rW>maxX){l=(rW-maxX)/-2}
if(rH>maxY){t=(rH-maxY)/-2}
image.css({"position":"absolute","top":(t)+"px","left":(l)+"px"}).fadeIn(100);}
onload(); image.one('load',function(){if(this.complete){$(this).load(onload);}});image.load(onload);}
function zeroPad(num,places){var zero=places-num.toString().length+1;return Array(+(zero>0&&zero)).join("0")+num;}
dateFormat={monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],_date:function(date){var _date=date?new Date(date):new Date();if(!_date.getFullYear()){_date=new Date(date.replace("-","/"))}
return _date;},_isCurrentYear:function(date){date=this._date(date);return date.getFullYear()==this._date().getFullYear();},monthAndYear:function(date){date=this._date(date);return this.monthNames[date.getMonth()]+' '+date.getFullYear()},monthDateYear:function(date){date=this._date(date);return this.monthNames[date.getMonth()]+' '+date.getDate()+', '+date.getFullYear();}};function niceDate(date,time){d=new Date(date.replace("-","/"))
var dateStr=zeroPad(d.getDate(),2)+"/"+zeroPad(d.getMonth()+1,2)+"/"+d.getFullYear()
if(time)
dateStr+=" "+zeroPad(d.getHours(),2)+":"+zeroPad(d.getMinutes(),2)+":"+zeroPad(d.getSeconds(),2)
return dateStr}
function pageTitle(title){$('title').html(title+" - Sellfy.com");}
function roundNumber(num,dec){return Math.round(num*Math.pow(10,dec))/Math.pow(10,dec);}
var moneyCalc={asMoney:function(amountInt){var amountFloat=roundNumber(parseFloat(amountInt),2)/100;var amountFixed=parseFloat(parseFloat(amountFloat)).toFixed(2);return amountFixed;}};function selectInputOnClick(event){event.currentTarget.select();}
function titleSlicer(title,maxLength){if(title&&title.length>maxLength&&maxLength){return title.slice(0,maxLength)+'...';}else{return title;}}
var CATEGORIES={'design':{name:'Design',slug:'design',subcategories:[{name:'Fonts',slug:'fonts'},{name:'Icons',slug:'icons'},{name:'Themes',slug:'themes'},{name:'Templates',slug:'templates'},{name:'Plugins & Add-ons',slug:'plugins'},{name:'Graphics',slug:'graphics'},{name:'UI kits',slug:'uikits'},{name:'Mockups',slug:'mockups'},{name:'Photos',slug:'photos'},{name:'Other',slug:'other'}]},'ebooks':{name:'Ebooks',slug:'ebooks',subcategories:[{name:'Comics',slug:'comics'},{name:'Health & Fitness',slug:'health'},{name:'Cooking',slug:'cooking'},{name:'Technology',slug:'technology'},{name:'Fiction',slug:'fiction'},{name:'Tutorials',slug:'tutorials'},{name:'Business',slug:'business'},{name:'Educational',slug:'education'},{name:'Design & Art',slug:'design'},{name:'Other',slug:'other'}]},'audio':{name:'Audio',slug:'audio',subcategories:[{name:'Music',slug:'music'},{name:'Beats & Samples',slug:'beats'},{name:'Audiobooks',slug:'audiobooks'},{name:'Podcasts',slug:'podcasts'},{name:'Audio FX',slug:'audiofx'},{name:'Other',slug:'other'}]},'video':{name:'Video',slug:'video',subcategories:[{name:'Indie movies',slug:'indie'},{name:'Sports',slug:'sports'},{name:'Documentary',slug:'documentary'},{name:'Tutorials',slug:'tutorials'},{name:'Technology',slug:'technology'},{name:'Other',slug:'other'}]},'soft':{name:'Software',slug:'soft',subcategories:[{name:'Games',slug:'games'},{name:'Mac apps',slug:'macapps'},{name:'Windows apps',slug:'winapps'},{name:'Android apps',slug:'androidapps'},{name:'Web software',slug:'websoft'},{name:'Video software',slug:'videosoft'},{name:'Music software',slug:'musicsoft'},{name:'Graphics software',slug:'graphicsoft'},{name:'Other',slug:'other'}]}};(function(scope){var _toString=Object.prototype.toString;function isDate(o){return'[object Date]'===_toString.call(o);}
function isRegExp(o){return'[object RegExp]'===_toString.call(o);}
var Cookie={get:function get(name){return Cookie.has(name)?Cookie.list()[name]:null;},has:function has(name){return new RegExp('(?:;\\s*|^)'+encodeURIComponent(name)+'=').test(document.cookie);},list:function list(nameRegExp){var pairs=document.cookie.split(';'),pair,result={};for(var index=0,len=pairs.length;index<len;++index){pair=pairs[index].split('=');pair[0]=pair[0].replace(/^\s+|\s+$/,'');if(!isRegExp(nameRegExp)||nameRegExp.test(pair[0])){result[decodeURIComponent(pair[0])]=decodeURIComponent(pair[1]);}}
return result;},remove:function remove(name,options){var opt2={};for(var key in(options||{})){opt2[key]=options[key];}
opt2.expires=new Date(0);opt2.maxAge=-1;return Cookie.set(name,null,opt2);},set:function set(name,value,options){options=options||{};var def=[encodeURIComponent(name)+'='+encodeURIComponent(value)];if(options.path){def.push('path='+options.path);}
if(options.domain){def.push('domain='+options.domain);}
var maxAge='maxAge'in options?options.maxAge:('max_age'in options?options.max_age:options['max-age']),maxAgeNbr;if('undefined'!==typeof maxAge&&null!==typeof maxAge&&(!isNaN(maxAgeNbr=parseFloat(maxAge)))){def.push('max-age='+maxAgeNbr);}
var expires=isDate(options.expires)?options.expires.toUTCString():options.expires;if(expires){def.push('expires='+expires);}
if(options.secure){def.push('secure');}
def=def.join(';');document.cookie=def;return def;}};scope.Cookie=Cookie;})(window);function lastVisitCookie(name){var day=60*60*24,options={path:'/',maxAge:30*day,};Cookie.set('last_visit',name,options);}
window.App={Models:{},Collections:{},Views:{},Mixins:{}};$.ajaxSetup({dataType:'json'});$.fn.modal.settings.debug=false;$.fn.dropdown.settings.debug=false;$.fn.dimmer.settings.debug=false;$.fn.popup.settings.debug=false;$.fn.transition.settings.debug=false;App.Backbone=Backbone.noConflict();App.contentView=null;oldRoutes={'dashboard':'dashboard','products':'allProducts','orders':'allOrders','settings/account':'settingsAccount','settings/profile':'settingsProfile','settings/password':'settingsPassword','settings/emails':'settingsEmails','settings/customization':'customizationOptions','settings/paymentoptions':'settingsPaymentOptions','settings/billing':'settingsBilling','settings/integrations':'settingsIntegrations','settings/location_tax':'settingsLocationTax'};oldRoutesResolvers={defaultRoute:function(){this.appView.renderContentStructure();},allProducts:function(){this.defaultRoute();},allOrders:function(){this.defaultRoute();},embedProduct:function(){this.defaultRoute();},dashboard:function(){this.defaultRoute();},settingsAccount:function(){this.defaultRoute();},settingsPassword:function(){this.defaultRoute();},settingsEmails:function(){this.defaultRoute();},customizationOptions:function(){this.defaultRoute();},settingsPaymentOptions:function(){this.defaultRoute();},settingsBilling:function(){this.defaultRoute();},settingsLocationTax:this.defaultRoute,invites:function(){this.defaultRoute();},recommend:function(){this.defaultRoute();},settingsIntegrations:function(){this.defaultRoute();}};App.Router=App.Backbone.Router.extend(_.extend({},oldRoutesResolvers,{routes:_.extend({},oldRoutes,{'marketing/discounts':'discounts','marketing/social-discounts':'socialDiscounts','marketing/email-updates':'emailUpdates','settings/location_tax':'settingsLocationTax','invite':'invites','recommend':'invites','feed':'feed','purchases':'purchases','products/new':'newProduct','products/:key/edit':'newProductEdit','*path':'dashboard'}),initialize:function(options){this.appView=options.appView;},discounts:function(){this.appView.renderContent(new App.Views.Discounts());},socialDiscounts:function(){this.appView.renderContent(new App.Views.SocialDiscounts());},invites:function(){this.appView.renderContent(new App.Views.Invites());},settingsLocationTax:function(){this.appView.renderContent(new App.Views.LocationTax());},feed:function(){App.Views.feed=new App.Views.Feed();this.appView.renderContent(App.Views.feed,true);},purchases:function(){this.appView.renderContent(new App.Views.Purchases());},newProduct:function(){this.appView.renderContent(new App.Views.ProductNew());},newProductEdit:function(key){productModel=new App.Models.Product({_id:key});this.appView.renderContent(new App.Views.ProductNew({model:productModel}));},emailUpdates:function(){this.appView.renderContent(new App.Views.EmailUpdates());}}));App.Views.FeedNotification=App.Backbone.View.extend({render:function(){var html=App.Templates.get('feedNotification');this.$el.html(html);this.updateUnreadCount();return this;},updateUnreadCount:function(){var that=this;$.get('/user/feed/api/unread_count/',function(resp){var count=resp.count,$feedCount=that.$('#feed-count');if(count>0){$feedCount.css('display','inline-block').attr('title','New products: '+count);}else{$feedCount.hide();}});}});$(function(){App.Templates.loadTemplates(base_pub_url+'static/js/app/',['templates'],function(){App.Views.appStructure=new App.Views.AppStructure({el:'#container'});App.router=new App.Router({appView:App.Views.appStructure});App.Views.notificationView=new App.Views.FeedNotification({el:'#feed_header_url'});App.Views.notificationView.render();App.Views.appStructure.render();App.Views.sideMenu=new App.Views.SideMenu();App.Views.headerMenu=new App.Views.HeaderMenu({el:'.header-notification-bar'});App.Backbone.history.start({pushState:true,root:'/user/'});$(document).on('click','a[data-pushstate]',function(e){var href=$(this).attr('href');appNavigate(App.router,href,e);});App.router.bind('route',function(){$(window).unbind('scroll.feedScrool');});});});var _navigation={'dashboard':{'_data':{'title':'Dashboard','url':siteUrl('dashboard')},'left':{'dashboard':{'key':'dashboard','routes':['dashboard','createNewName'],'title':'Dashboard','url':siteUrl('dashboard'),'icon':'icon-bar-chart'},'products':{'key':'products','routes':['allProducts','embedProduct','editProduct','productAdvanced','newProduct','invites'],'title':'Products','icon':'icon-inbox','_children':[{'routes':['newProduct',],'title':'Add new product','url':siteUrl('products/new')},{'routes':['allProducts','editProduct','newProductEdit'],'title':'My products','url':siteUrl('products')},]},'marketing':{'key':'marketing','routes':['discounts','socialDiscounts','emailUpdates'],'title':'Marketing','icon':'beta-custom-icon','_children':[{'routes':['emailUpdates',],'title':'E-mail updates','url':siteUrl('marketing/email-updates')},{'routes':['discounts',],'title':'Discount codes','url':siteUrl('marketing/discounts')},{'routes':['socialDiscounts',],'title':'Social discounts','url':siteUrl('marketing/social-discounts')}]},'orders':{'key':'orders','routes':['allOrders'],'title':'Orders','url':siteUrl('orders'),'icon':'icon-list-alt'}}},'settings':{'_data':{'title':'Settings','url':siteUrl('settings/account')},'left':{'account':{'key':'account','routes':['settingsAccount'],'title':'Account Settings','url':siteUrl('settings/account')},'locationTax':{'key':'location_settings','routes':['settingsLocationTax'],'title':'Location & Tax','url':siteUrl('settings/location_tax')},'payment_options':{'key':'payment_options','routes':['settingsPaymentOptions'],'title':'Payment Options','url':siteUrl('settings/paymentoptions')},'customization':{'key':'customization','routes':['customizationOptions'],'title':'Email Settings','url':siteUrl('settings/customization')},'email_settings':{'key':'email_settings','routes':['settingsEmails'],'title':'Notifications','url':siteUrl('settings/emails')},'change_password':{'key':'change_password','routes':['settingsPassword'],'title':'Change Password','url':siteUrl('settings/password')},'integrations':{'key':'integrations','routes':['settingsIntegrations'],'title':'Integrations','url':siteUrl('settings/integrations')}}},'logout':{'_data':{'title':'<span class="icon-off"></span>','url':base_pub_url+'logout/'},'left':{}}}
App.Views.HeaderMenu=App.Backbone.View.extend({initialize:function(){App.router.on('route',this.makeActive,this);},makeActive:function(route){this.$('.header-menu').removeClass('active');if(route==='feed'){this.$('.header-menu[data-top-menu="'+route+'"]').addClass('active');}else if(route==='newProduct'){this.$('.header-menu[data-top-menu="newProduct"]').addClass('active');}}});App.Views.SideMenu=App.Backbone.View.extend({activeRoute:null,el:'#left_menu',events:{'click .submenu .item':'makeActiveSubMenu'},initialize:function(){App.router.on('route',this.render,this);},render:function(route){var activeMenus=this.getActiveLeftMenu(navigation,route),menu=_navigation[activeMenus.active_parent];if(menu){menu=menu.left;menu=this.setActiveMenu(menu,route);var leftMenuData={menu:menu,active:activeMenus.active_left,_:_};var html=_.template(App.Templates.get('sideMenu'),leftMenuData);this.$el.html(html);}},setActiveMenu:function(menu,route){var that=this,activeRoute=route;$.each(menu,function(menuKey,menuAttr){if(menuAttr.routes.indexOf(activeRoute)!==-1){menuAttr._is_active=true;menu[menuKey]=menuAttr;}else{menuAttr._is_active=false;}
if(menuAttr._children){menuAttr_children=that.setActiveMenu(menuAttr._children,route);}});return menu;},makeActiveSubMenu:function(e){var item=$(e.currentTarget);$('#left_menu .active').removeClass('active');this.$('.active').removeClass('active');item.parent('.submenu').find('.item').removeClass('active');item.addClass('active');},getActiveLeftMenu:function(menu,route){var active;var active_parent
$.each(menu,function(x,rl){$.each(rl.left,function(mk,mv){$.each(mv['routes'],function(k,r){if(r==route){active=mk
active_parent=x}});});});return{'active_left':active,'active_parent':active_parent}}});App.Templates={templates:{},loadTemplates:function(prefix,names,callback){var that=this;var loadTemplate=function(index){var name=names[index];var uniq='uniq'
try{scripts=document.getElementsByTagName("script");$.each(scripts,function(k,script){src=$(script).attr("src")
if(src){if(src.indexOf("packed_user")!==-1){uniq=src.slice(src.indexOf("packed_user")+("packed_user").length,src.indexOf(".js"))}}})}catch(Exception){}
$.get(prefix+name+'.html?'+uniq,function(data){$.each($(data),function(k,t){var el=$(t)
if(el.attr('type')=='text/template'){that.templates[el.attr("id")]=el.html()}})
index++;if(index<names.length){loadTemplate(index);}else{callback();}});}
loadTemplate(0);}, get:function(name){return this.templates[name];}};App.Views.AppStructure=App.Backbone.View.extend({render:function(){this.$el.html(_.template(App.Templates.get('appStructure'),{}));return this;},renderContentStructure:function(fullWidth){this.$('#content_container').empty();this.$('#content_container').html(App.Templates.get('contentStructure'));if(fullWidth){this.$el.addClass('super-wide');}else{this.$el.removeClass('super-wide');}
return this;},renderContent:function(view,fullWidth){if(this.currentView){this.currentView.remove();this.currentView.unbind();}
this.currentView=view;this.renderContentStructure(fullWidth);this.assign(this.currentView,'#content');},assign:function(view,selector){view.setElement(this.$(selector)).render();}});App.Views.PageTitle=App.Backbone.View.extend({title_defaults:{title:'Page Title',description:null,iconClass:null,button:null},render:function(titleOptions){var html=_.template(App.Templates.get('pageTitle'),_.extend({},this.title_defaults,titleOptions||{}));this.$el.html(html);}});App.Mixins.AppUiView={contentEl:'#container_for_page_body',noItemsUI:{text:'No items to show.',arrow:false},renderPagination:function(){this.paginationView.setElement(this.$('#container_for_pagintion')).render();},renderPageTitle:function(titleOptions){this.pageTitleView=new App.Views.PageTitle();this.pageTitleView.setElement(this.$('#container_for_title')).render(titleOptions);},renderPageLoader:function(selector){this.$(selector).html(App.Templates.get('pageLoader'));this.$('.dimmer').hide(0).delay(250).show(0);return this;},renderNoItems:function(selector){this.$(selector).html(_.template(App.Templates.get('noItem'),this.noItemsUI));return this;},checkListingSize:function(selector){if(this.$(selector).children().length==0){this.renderNoItems(selector);}},renderAll:function(){this.$('#listing').empty();if(this.collection.length){this.collection.each(this.renderOne,this);}else{this.renderNoItems('#listing')}}}
App.Views.DeletionConfirm=App.Backbone.View.extend({events:{'click .yes':'doDelete'},render:function(title,callback){var that=this;$('.modal').remove();this.deletionCallback=callback;this.$el.html(_.template(App.Templates.get('deletionConfirm'),{title:title}));this.modal=this.$('.small.modal').modal('setting',{duration:200,selector:{close:'.close, .actions .button',approve:'.actions .yes'}});this.$el=this.modal;this.$el.modal('setting',{onShow:function(){that.delegateEvents();}})
this.$el.modal('show')
return this;},doDelete:function(){this.deletionCallback();this.$el.modal('hide')
this.remove();}})
App.Mixins.ListingItem={deletionConfirm:function(title,callback){this.deletionVConfirmView=new App.Views.DeletionConfirm();this.deletionVConfirmView.render(title,callback);}}
App.Mixins.RequestPagerCollection={paginator_core:{type:'GET',dataType:'json',url:function(){return this.url}},paginator_ui:{firstPage:1,currentPage:1,perPage:10,totalPages:10},server_api:{'first_page':1,'per_page':function(){return this.perPage},'page':function(){return this.currentPage}},parse:function(response){var results=response.data;this.totalPages=response.pagination.pages_total;this.totalRecords=response.pagination.items_total;return results;}}
App.Views.PaginatedView=App.Backbone.View.extend({events:{'click a.servernext':'nextResultPage','click a.serverprevious':'previousResultPage','click a.orderUpdate':'updateSortBy','click a.last':'gotoLast','click a.page':'gotoPage','click a.first':'gotoFirst','click a.serverpage':'gotoPage','click .serverhowmany a':'changeCount'},initialize:function(){},render:function(){var html=_.template(App.Templates.get('serverPagination'),this.collection.info());this.$el.html(html);return this;},updateSortBy:function(e){e.preventDefault();var currentSort=$('#sortByField').val();this.collection.updateOrder(currentSort);},nextResultPage:function(e){e.preventDefault();this.collection.requestNextPage();},previousResultPage:function(e){e.preventDefault();this.collection.requestPreviousPage();},gotoFirst:function(e){e.preventDefault();this.collection.goTo(this.collection.information.firstPage);},gotoLast:function(e){e.preventDefault();this.collection.goTo(this.collection.information.lastPage);},gotoPage:function(e){e.preventDefault();var page=$(e.target).text();this.collection.goTo(page);},changeCount:function(e){e.preventDefault();var per=$(e.target).text();this.collection.howManyPer(per);}});App.Models.Product=App.Backbone.Model.extend({idAttribute:'key',defaults:{_image:{url:''},discount:{discount:'',enabled:true,message:''}},url:function(){var key_string='';if(this.get('_id')){key_string=this.get('_id')+'/';}
else if(this.get('key')){key_string=this.get('key')+'/';}
return apiUrl('products/')+key_string;},initialize:function(){var that=this;this.on('sync add',function(){that.initFields();this.unset('file');this.unset('image');});},initFields:function(){if(_.isObject(this.get('file'))){this.set('_file',this.get('file'));this.unset('file');}
if(_.isObject(this.get('image'))){this.set('_image',this.get('image'));this.unset('image');}},imageUrl:function(){return this.get('_image').url||'';}});App.Collections.ProductNames=App.Backbone.Collection.extend({model:App.Models.Product,url:apiUrl('products/?only=name,key,discount,id&per_page=-1&'),initialize:function(options){if(options&&options.filter){this.parseFilter=options.filter;}},parse:function(response){if(this.parseFilter){return this.parseFilter(response);}else{return response.data;}}});App.Collections.ProductImages=App.Backbone.Collection.extend({model:App.Models.Product,url:apiUrl('products/?only=name,key,image&per_page=-1&'),parse:function(response){return response.data;}});App.Collections.productImages=new App.Collections.ProductImages();App.Views.ProductNew=App.Backbone.View.extend(_.extend({},{edit:false,created:false,events:{'click .product-upload-file':'fileUpload','click #delete-product':'deleteProduct','click #share_product':'productShare','submit #product_new_edit_form':'formSubmit','change #price':'prettyPrice','change input':'updateFields','change #marketplace_enabled':'changeMarketplaceState'},initialize:function(){if(this.model){this.edit=true;this.model.fetch();}else{this.model=new App.Models.Product();}
this.listenTo(this.model,'add sync reset',this.render);},render:function(){if(!this.edit){pageTitle('Create product');}else{pageTitle('Edit product');}
if(!this.model.get('_image').url){this.model.set({'_image':{'url':this.model.defaults._image.url}});}
var html=_.template(App.Templates.get('productCreateBaseView'),{_:_,p:this.model,edit:this.edit,created:this.created});if(!this.edit||(this.edit&&typeof this.model.get('name')!=='undefined')){this.$el.html(html);this.initJs();}
return this;},initJs:function(){var _this=this,$sidebar=$('.my_account');this.$product_image_upload=$('#product_image_upload');this.$product_image=$('.product-upload-image');this.imgPreview=this.$product_image_upload.edit_prod_tooltip({scale:'image',action:base_url+'api/v1/me/images/',onUploadCompleted:function(resp){if(resp){if(resp.id){$('input[name="image"]').val(resp.id);_this.imageUpdate(resp.url);}
else if(resp.error){show_noty('There was a problem uploading your image. Please try to upload different image.','error',5000);_this.$product_image.removeClass('uploading');}}},onUploadProcess:function(){_this.$product_image.removeClass('dragenter').addClass('uploading');}});this.positionImageUpload();this.fileUploader(this);this.prettyPrice();this.stampingToggle();this.$('.popup-ready').popup();this.$('.ui.dropdown').dropdown();this.$('.product-category').dropdown({onChange:function(value){_this.updateCategories(value);}});this.$el.on({dragenter:function(){_this.$product_image.addClass('dragenter');},dragleave:function(){_this.$product_image.removeClass('dragenter');}},'#product_image_upload input');if(this.model.get('category')){this.updateCategories(this.model.get('category'));}
if($sidebar.is(':hidden')){$sidebar.show();}
lastVisitCookie('dashboard');},positionImageUpload:function(){var top=-1*parseInt(this.$('#new_product_container').css('padding-top'));$('.product-upload-image').parentsUntil('#product_new_edit_form').each(function(){top+=$(this).position().top;});this.$('#product_image_upload').css('top',top);},formSubmit:function(event){var _this=this;event.preventDefault();this.updateFields();this.model.save({},{'success':function(model){if(!_this.edit){_this.edit=true;_this.created=true;show_noty('Product created successfully! Redirecting..','success');redirect('{0}p/{1}/#embed'.format(base_pub_url,model.id));}else{_this.showModal=false;show_noty('Updated!','success');}
_this.$('#file').val('');},'error':function(model,resp){resp=jQuery.parseJSON(resp.responseText);show_noty(resp.error);}});return false;},deleteProduct:function(){var _this=this,deleteCallback=function(){_this.model.destroy();App.router.navigate('products/new',true);};notification('Are you sure that you want to remove this product?','warning',null,deleteCallback);return false;},updateFields:function(){var _this=this;$form=this.$el.find('#product_new_edit_form');$.each($form.serializeArray(),function(index,field){var name=field.name,value=field.value;if(name==='price'){value=mti(value);}
_this.model.set(name,value);});_this.model.set('public',_this.$el.find('#public').is(':checked'));_this.model.set('pdf_stamping',_this.$el.find('#pdf_stamping').is(':checked'));_this.model.set('marketplace_enabled',_this.$el.find('#marketplace_enabled').is(':checked'));},imageUpdate:function(url){this.$product_image.addClass('with-image').removeClass('uploading').css('background-image','url({0})'.format(url));},fileUpload:function(){$('#upl_file').click();},fileUploadProgress:function(loaded,total){var percents=parseInt(loaded/total*100),upload_progress='{0}%'.format(percents);this.$('.product-upload-percents .percents').text(upload_progress);this.$('.product-upload-bar').width(upload_progress);},fileUploadFinish:function(){this.$('.progress-bar-wrap, .product-upload-percents').addClass('editing');},fileUploadName:function(name){this.$('.product-upload-name').text(name);this.$('.progress-bar-wrap, .product-upload-percents').removeClass('editing');this.$('.setting-button-holder, .product-upload-form-wrap, .product-image-upload').addClass('editing');this.$('.product-drag-drop').hide();this.stampingHide();this.positionImageUpload();},fileUploader:function(){var that=this,s3upload=new S3Upload({file_dom_drop:'#droptext',file_dom_selector:'#upl_file',s3_sign_put_url:api_url_me+'amazon/',onProgress:function(percent,message,publicUrl,file,e){try{if(e.loaded){that.fileUploadProgress(e.loaded,e.total);}}catch(e){}},showOploadOptions:function(){that.fileUploadFinish();that.stampingToggle();},onFinishS3Put:function(){$.post(api_url_me+'files/?amazon=1',{full_key:this.sign_response.path},function(resp){that.$('#file').val(resp.id);that.model.set({'_file':{'extension':resp.extension}});s3upload.showOploadOptions();});},onError:function(){notification('File upload failed. Please try again later','error',5000);this.showOploadOptions();},onDragEnter:function(e){$(e.target).addClass('dragenter');},onDragLeave:function(e){$(e.target).removeClass('dragenter');},onDrop:function(e){var fileName;e.preventDefault();try{fileName=e.originalEvent.dataTransfer.files[0].name;}catch(error){fileName=e.currentTarget.files[0].name;}
that.fileUploadName(fileName);$(e.target).parent().removeClass('dragenter');}});},prettyPrice:function(){var $obj=this.$('#price'),price=$obj.val(),cur=this.$('#currency').val(),priceLim=9999;price=parseFloat(price);if(cur==='JPY'){priceLim=999999;}
if(price<0.90||isNaN(price)){price=0.90;}else if(price>priceLim){price=priceLim;}
price=price.toFixed(2);$obj.val(price);},stampingToggle:function(){if(this.model.get('_file')&&this.model.get('_file').extension==='.pdf'){this.$('#pdf_stamping_cont').show();}else{this.stampingHide();}},stampingHide:function(){this.$('#pdf_stamping_cont').hide();},updateCategories:function(value){var _this=this,$subcategory=this.$('.product-subcategory'),$subcategory_menu=$subcategory.find('.menu');$subcategory_parent=$subcategory.parent();$subcategory_menu.empty();$.each(CATEGORIES[value].subcategories,function(index,item){var item_class=selectDropdownOption(_this.model.get('subcategory'),item.slug);$subcategory_menu.append('<div class="item {2}" data-value="{0}">{1}</div>'.format(item.slug,item.name,item_class));});$subcategory_parent.addClass('enabled');$subcategory.dropdown();if($subcategory_menu.find('.active').length===0){$subcategory.find('.text').text('Select sub-category');}},productShare:function(e){e.preventDefault();this.sharePopupView=new App.Views.ProductSharePopup(this.model);this.sharePopupView.setElement(this.$('#product_share_modal_holder')).render();return false;}}));App.Models.User=App.Backbone.Model.extend({url:apiUrl(''),defaults:{merchant_name:''}});App.Views.ProductSharePopup=App.Backbone.View.extend({events:{'change #change_embed_code':'embedCodeChange','click .embed-code-holder input':'selectInputText'},initialize:function(model){this.model=model;},render:function(){var _this=this,html=_.template(App.Templates.get('productSharePopupView'),{_:_,product:this.model,image:this.productImage()});this.$el.html(html);this.modal=this.$('.modal').modal({onShow:function(){_this.delegateEvents();}});this.$el=this.modal;this.modal.modal('show');return this;},embedCodeChange:function(e){$checkbox=$(e.currentTarget);this.$('.embed-code-holder').toggleClass('new-window',$checkbox.is(':checked'));},selectInputText:function(e){selectText($(e.currentTarget));},productImage:function(){if(this.model.get('_image')&&this.model.get('_image').url){return this.model.get('_image').url;}else{return'https://static.sellfy.com/media/css/images/product-default-placeholder.png';}}});App.Models.InviteModel=App.Backbone.Model.extend({url:apiUrl('invite'),defaults:{times_completed:0,fee:{amount:5,expires:null}}});App.Views.Invites=App.Backbone.View.extend(_.extend({},App.Mixins.AppUiView,{events:{'click #invite_share':'facebookShare','click #invite_tweet':'twitterShare','click #invite_link':'selectInput'},initialize:function(){this.model=new App.Models.InviteModel();this.listenTo(this.model,'sync reset',this.renderMain);this.model.fetch();},render:function(){baseView.setPageSize('wide');pageTitle('Invite your friends!');return this;},moveProgressBar:function(count){var width=Math.ceil(count/6*100)+'%';this.$el.find('#progress_bar').width(width);},renderMain:function(){var html=_.template(App.Templates.get('inviteMain'),{_:_,model:this.model});this.$el.html(html);this.moveProgressBar(this.model.get('times_completed'));this.initTwitter();return this;},initTwitter:function(){var _this=this;window.twttr.ready(function(twttr){twttr.events.bind('tweet',function(){_this.successShare();});});},facebookShare:function(){var _this=this;FB.ui({method:'feed',link:this.model.get('url'),},function(response){if(response&&response.post_id){_this.successShare();}});return false;},successShare:function(){var that=this;$.post('/user/invite/share_callback/',{},function(){that.model.fetch();});},selectInput:function(e){selectInputOnClick(e);}}));function productSelectionHtml(productCollection,maxLength){return _.template(App.Templates.get('productSelection'),{_:_,products:productCollection,maxLength:maxLength,titleSlicer:titleSlicer});}
App.Models.Discount=App.Backbone.Model.extend({idAttribute:'id',defaults:{},initialize:function(){this.listenTo(this,'sync add',this.setProductModel);},url:function(){if(!this.isNew())
return apiUrl('discount_codes/')+this.get("id")+"/";else
return apiUrl('discount_codes/');},setProductModel:function(){if(this.get('product')&&!_.has(this,'_product')){var product=App.Collections.productImages.get(this.get('product'));this._product=product;}}});App.Collections.Discounts=App.Backbone.Paginator.requestPager.extend(_.extend({},App.Mixins.RequestPagerCollection,{model:App.Models.Discount,url:apiUrl('discount_codes/')}));App.Views.Discount=App.Backbone.View.extend(_.extend({},App.Mixins.ListingItem,{className:'ui grid row form one-record',events:{'click .remove':'removeDiscount','click .edit':'renderEditDiscount'},render:function(){var html=_.template(App.Templates.get('oneDiscount'),{_:_,model:this.model,imageUrl:this.getProductImageUrl(this.model)});this.$el.html(html);fitImageIn(this.$('.preview-image'),this.$('.preview-image').parent());this.$('.ui.dropdown').dropdown();return this;},removeDiscount:function(){var that=this;this.deletionConfirm('Delete this coupon code?',function(){that.model.destroy();that.$el.remove();that.trigger('destroyed');});},renderEditDiscount:function(){if(this.discountCreationView){this.discountCreationView.remove();this.discountCreationView.unbind();}
this.discountCreationView=new App.Views.DiscountSetup({model:this.model});this.discountCreationView.render();this.discountCreationView.modal.modal('show');},getProductImageUrl:function(model){var product=App.Collections.productImages.get(model.get('product'));return product.imageUrl();}}));App.Views.DiscountSetup=App.Backbone.View.extend({model:App.Models.Discount,events:{'click .submit':'submitDiscount','keyup input':'setInputValue','change input':'setInputValue'},initialize:function(){this.productsNames=new App.Collections.ProductNames();this.productsNames.on('sync reset',this.renderProductSelection,this);this.model.on('error',this.showError,this);},setInputValue:function(e){var input=$(e.currentTarget);this.model.set(input.attr('name'),input.val());},render:function(){var that=this;var html=_.template(App.Templates.get('discountSetup'),{_:_,model:this.model,title:this.model.isNew()?'Add new discount code':'Edit discount code',saveButtonText:this.model.isNew()?'Create':'Save'});$('.modal').remove();this.$el.html(html);this.modal=this.$('.modal.marketing-form').modal('setting',{closable:true,selector:{close:'.close'}}).modal({onShow:function(){if(that.model.isNew()){that.renderProductSelection();}
that.delegateEvents();}});this.$el=this.modal;if(this.model.isNew()){this.productsNames.fetch();}
return this;},showError:function(model,response){var message=$.parseJSON(response.responseText).error;this.$('.modal-error .message').html(message);this.$('.modal-error').show();},renderProductSelection:function(){var that=this;this.$('.product-selection').html(productSelectionHtml(this.productsNames,24))
this.$('.ui.selection.dropdown').dropdown({onChange:function(productKey){that.model.set('product',productKey)}})},submitDiscount:function(){var that=this;var isNew=this.model.isNew();this.model.save({},{success:function(){if(isNew){that.trigger('modelCreated',that.model);}else{that.trigger('modelUpdated',that.model);}
that.$el.modal('hide');}});return false;}});App.Views.Discounts=App.Backbone.View.extend(_.extend({},App.Mixins.AppUiView,{noItemsUI:{text:'Discount codes allows to give special prices '+'to your clients and create promotional campaigns.',arrow:true},events:{'click .header-button':'renderDiscountCreation'},initialize:function(){var that=this;this.collection=new App.Collections.Discounts()
this.collection.is_discount=true;this.paginationView=new App.Views.PaginatedView({collection:this.collection});this.listenTo(this.collection,'sync reset',this.renderAll);this.listenTo(this.collection,'sync reset',this.renderPagination);this.listenTo(App.Collections.productImages,'sync reset',function(){that.collection.fetch();});App.Collections.productImages.fetch();},render:function(){this.renderPageTitle({title:'Discount codes',button:{icon:'add',text:'Add discount code'}});this.$(this.contentEl).html(App.Templates.get('discountCodes'));this.renderPageLoader('#listing');pageTitle('Discount codes');return this;},renderDiscountCreation:function(){var that=this;if(this.discountCreationView){this.discountCreationView.remove();this.discountCreationView.unbind();}
this.discountCreationView=new App.Views.DiscountSetup({model:new App.Models.Discount()});this.discountCreationView.on('modelCreated modelUpdated',function(){that.collection.fetch();});this.discountCreationView.setElement(this.$('#creation')).render();this.discountCreationView.modal.modal('show');},renderOne:function(model){var discountView=new App.Views.Discount({model:model});this.listenTo(discountView,'destroyed',function(){this.checkListingSize('#listing');})
this.$('#listing').append(discountView.render().$el);}}));App.Collections.SocialDiscounts=App.Backbone.Paginator.clientPager.extend({model:App.Models.Product,url:apiUrl('products/?only=name,key,price,image,discount,message&per_page=-1'),paginator_core:{type:'GET',dataType:'json',url:function(){return this.url}},paginator_ui:{firstPage:1,currentPage:1,perPage:10,totalPages:10},parse:function(response){var items=_.filter(response.data,function(doc){return doc.discount&&doc.discount.enabled==true;});return items;}});App.Views.SocialDiscount=App.Backbone.View.extend(_.extend({},App.Mixins.ListingItem,{className:'ui grid row form one-record',events:{'click .remove':'removeDiscount','click .edit':'renderEditDiscount'},render:function(){var that=this;var html=_.template(App.Templates.get('socialDiscount'),{_:_,model:this.model});this.$el.html(html);fitImageIn(this.$('.preview-image'),this.$('.preview-image').parent());this.$('.ui.dropdown').dropdown({onShow:function(){that.delegateEvents()}});return this;},removeDiscount:function(){var that=this;this.deletionConfirm('Delete this social discount?',function(){that.model.set({discount:{enabled:false}});that.model.save();that.remove();that.trigger('destroyed');});},renderEditDiscount:function(){var that=this;if(this.discountCreationView){this.discountCreationView.remove();this.discountCreationView.unbind();}
this.discountCreationView=new App.Views.SocialDiscountSetup({model:this.model});this.discountCreationView.render();this.discountCreationView.modal.modal('show');this.discountCreationView.on('modelCreated',function(model){that.render()});}}));App.Views.SocialDiscounts=App.Backbone.View.extend(_.extend({},App.Mixins.AppUiView,{noItemsUI:{text:'Social discounts will enable you to give discounts to clients '+'who recommends your products to their friends via Facebook or Twitter.',arrow:true},events:{'click .header-button':'renderDiscountCreation'},initialize:function(){var that=this;this.collection=new App.Collections.SocialDiscounts();this.collection.origModels=[];this.listenTo(this.collection,'reset',this.renderAll);this.listenTo(this.collection,'sync reset',this.renderPagination);this.paginationView=new App.Views.PaginatedView({collection:this.collection});this.collection.fetch({success:function(){that.collection.pager();}});},render:function(){this.renderPageTitle({title:'Social discounts',button:{icon:'add',text:'Add discount'}});this.$(this.contentEl).html(App.Templates.get('socialDiscounts'));this.renderPageLoader('#listing');pageTitle('Social discounts');return this;},renderDiscountCreation:function(){var that=this;if(this.discountCreationView){this.discountCreationView.remove();this.discountCreationView.unbind();}
this.discountCreationView=new App.Views.SocialDiscountSetup({model:new App.Models.Product()});this.discountCreationView.on('modelCreated',function(model){that.collection.add(model,{at:0});that.renderAll()});this.discountCreationView.setElement(this.$('#creation')).render();this.discountCreationView.modal.modal('show');},renderOne:function(model,prepend){var view=new App.Views.SocialDiscount({model:model});if(prepend===true){this.$('#listing').prepend(view.render().$el);}else{this.$('#listing').append(view.render().$el);}
this.listenTo(view,'destroyed',function(){this.checkListingSize('#listing');})}}));App.Views.SocialDiscountSetup=App.Backbone.View.extend({events:{'click .submit':'submitDiscount','keyup input, textarea':'setInputValue','change input, textarea':'setInputValue'},initialize:function(){this.productsNames=new App.Collections.ProductNames({filter:function(response){var items=_.filter(response.data,function(doc){return!doc.discount.enabled;});return items;}});this.listenTo(this.productsNames,'sync reset remove',this.renderProductSelection);this.model=this.model||new App.Models.Product();this.model.on('error',this.showResponseError,this);},changeCurrentModel:function(productKey){var tmpDiscountObj=this.model.get('discount');this.model=this.productsNames.findWhere({key:productKey.toString()});this.model.set('discount',tmpDiscountObj);this.model.on('error',this.showResponseError,this);},setInputValue:function(e){var input=$(e.currentTarget);var discountObj=this.model.get('discount')||{};discountObj[input.attr('name')]=input.val()||input.text();discountObj['enabled']=true;this.model.set('discount',discountObj);},render:function(){var that=this;var html=_.template(App.Templates.get('socialDiscountSetup'),{_:_,model:this.model,title:this.model.isNew()?'Add new social discount':'Edit social discount',saveButtonText:this.model.isNew()?'Create':'Save'});$('.modal.marketing-form').remove();this.$el.html(html);this.modal=this.$('.modal.marketing-form').modal('setting',{closable:true,selector:{close:'.close'}}).modal({onShow:function(){if(that.model.isNew()){that.renderProductSelection();}
that.delegateEvents();}});this.$el=this.modal;if(this.model.isNew()){this.productsNames.fetch();}
return this;},showResponseError:function(model,response){var message=$.parseJSON(response.responseText).error;this.showError(message);},showError:function(message){this.$('.modal-error .message').html(message);this.$('.modal-error').show();},showCreateNewBtn:function(){this.$('#setup-start').show();this.$('#setup-form').hide();},showCreateNewForm:function(){this.$('#setup-start').hide();this.$('#setup-form').show();},resetFields:function(){this.model.set('product',this.$el.find('.ui.selection.dropdown').dropdown('get value'))
this.$el.find('input[type="text"]').val('')},renderProductSelection:function(){var that=this;this.$('.product-selection').html(productSelectionHtml(this.productsNames,25))
this.$('.ui.selection.dropdown').dropdown({onChange:function(productKey){that.changeCurrentModel(productKey.toString())}})},submitDiscount:function(){var that=this;if(this.model.isNew()){this.showError('Please choose product!');}else{this.model.save({},{success:function(){that.trigger('modelCreated',that.model);that.productsNames.remove(that.model);that.$el.modal('hide');}});}
return false;}});App.Models.EmailUpdateModel=App.Backbone.Model.extend({url:apiUrl('emails/')});App.Views.EmailUpdates=App.Backbone.View.extend({events:{'change .email-update-form .model-element':'updateModel','submit .email-update-form':'formSubmit'},initialize:function(){this.products=new ProductAllSoldCollection();this.model=new App.Models.EmailUpdateModel();this.listenTo(this.products,'sync reset',this.render);this.listenTo(this.model,'error',this.modelUpdatedError);this.listenTo(this.model,'sync',this.modelUpdatedSuccess);this.products.fetch();},render:function(){pageTitle('E-mail updates');this.renderContent();return this;},renderContent:function(){var _this=this,html=_.template(App.Templates.get('emailUpdatesView'),{_:_,products:this.products});this.$el.html(html);this.$('.email-update-dropdown').dropdown({onChange:function(){_this.updateModel();_this.calculateClients();}});$('.popup-ready.email-update-popup').popup();},updateModel:function(){var form=this.$('.email-update-form').serializeArray(),_this=this;$.each(form,function(){_this.model.set(this.name,this.value);});},calculateClients:function(){var recipient=this.model.get('recipient'),_this=this;$.get(apiUrl('emails/')+recipient+'/',{},function(resp){_this.$('.email-update-recipient-count').text(resp.clients);});},formSubmit:function(event){event.preventDefault();this.updateModel();this.model.save();return false;},modelUpdatedSuccess:function(){show_noty('Message is sent','success');},modelUpdatedError:function(model,resp){show_noty(resp.responseJSON.error);}});App.Models.TaxUser=App.Backbone.Model.extend({idAttribute:'id',initialize:function(){this.set('id',1);_.bindAll(this,'onModelSaved');},onModelSaved:function(model,response,options){console.log(response);},defaults:{location:{country:'AF',state:''},tax:{percents:0,prices_include_tax:false,}},url:'/api/v2/me/fulfillment/'});App.Views.LocationTax=App.Backbone.View.extend(_.extend({},App.Mixins.AppUiView,{events:{'click #footer-save-settings':'saveSettings','change input[name="tax"]':'setTaxAmount'},initialize:function(){this.model=new App.Models.TaxUser();this.listenTo(this.model,'sync reset',this.renderAll);this.model.fetch();},render:function(){this.renderPageTitle({title:'Location & Tax'});},onLocationChange:function(country,state){var location=this.model.get('location');location.country=country?country:location.country;location.state=state?state:location.state;if(country){this.$('.state-row').toggle(country==='US');}
this.renderTaxSelection(country,state);this.model.set('location',location);},renderAll:function(){var that=this;var html=_.template(App.Templates.get('locationTax'),{_:_,countries:COUNTRIES,countryOrder:COUNTRY_ORDER,states:STATES,stateOrder:STATE_ORDER});this.$(this.contentEl).html(html);var location=that.model.get('location');var tax=this.model.get('tax');this.$('.state-row').hide();location.country=location.country||'';this.$('.country-dropdown').dropdown({onChange:function(countryCode){that.onLocationChange(countryCode,null);that.showTax(that.defaultTax(location.country,location.state));},onShow:function(){$(this).find('.search-field').focus();},onHide:function(){$(this).focus();}}).dropdown('set selected',location.country);this.$('.state-dropdown').dropdown({onChange:function(stateCode){that.onLocationChange(null,stateCode);that.showTax(that.defaultTax(location.country,location.state));},onShow:function(){$(this).find('.search-field').focus();},onHide:function(){$(this).focus();}}).dropdown('set selected',location.state);this.$('.currency-dropdown').dropdown({onChange:function(currencyCode){that.model.set('currency',currencyCode);}}).dropdown('set selected',this.model.get('currency'));var prices_include_tax=tax.prices_include_tax===true?true:false;$('.ui.checkbox.include-tax').checkbox({onEnable:function(){that.setTaxType(true);},onDisable:function(){that.setTaxType(false);}}).checkbox(prices_include_tax?'enable':'disable');this.onLocationChange(location.country,location.state);this.showTax(tax.percents||0);this.renderFooter();$('.search-dropdown').dropdown_search();return this;},renderCountryList:function(){var html='';},renderFooter:function(){var html=App.Templates.get('saveSettings');$(html).insertAfter(this.$('.userpage_content'));},setTaxType:function(prices_include_tax){var tax=this.model.get('tax');tax.prices_include_tax=prices_include_tax;this.model.set('tax',tax);},setTaxAmount:function(e){var tax=this.model.get('tax');tax.percents=parseFloat($(e.currentTarget).val());this.model.set('tax',tax);},saveSettings:function(){this.model.save({},{success:function(){show_noty('Updated!','success')},error:function(model,resp){var errors=resp.responseJSON.errors[0];if(errors.state){error_text='Please select state';}else if(errors.percents){error_text='Please enter correct tax 0 - 99%';}else{error_text='Please check out Tax form';}
show_noty(error_text);}});},showTax:function(value){this.$('input[name="tax"]').val(parseFloat(value).toFixed(2));this.$('input[name="tax"]').trigger('change');},defaultTax:function(country,state){var amount=state&&country=='US'?STATES['US'][state].tax:COUNTRIES[country].tax
return parseFloat(amount)*100;},renderTaxSelection:function(country,state){var options=[],that=this;if(state){options.push([state,STATES['US'][state].name]);country='US';}
if(country){options.push([country,COUNTRIES[country].name]);}
if(REGIONS['R_EU'].members.indexOf(country)!=-1){options.push(['R_EU','European Union']);}
options.push(['WORLD','Entire World']);var html=_.template(App.Templates.get('taxAppliesDropdown'),{_:_,options:options});var selected=_.find(options,function(obj){return obj[0]==that.model.get('tax').location;})||options[0];this.$('#tax-selection-cont').html(html);this.$('.tax-applies-dropdown').dropdown({onChange:function(location){that.onTaxChange(location);}}).dropdown('set selected',selected[0]);this.onTaxChange(selected[0]);},onTaxChange:function(location){var tax=this.model.get('tax');tax.location=location;this.model.set('tax',tax);}}));var HeaderImageUploader=function($container){this.$container=$container;}
var headerImageUploader=new HeaderImageUploader()
App.Views.HeaderImageUploader=App.Backbone.View.extend({'events':{'change form input[type="file"]':'uploadImage','change iframe':function(){alert("iframe")}},initialize:function(){},render:function(){this.$el.html(_.template(App.Templates.get('headerImageUploader'),{imageUrl:this.model.get('header_image')}));this.hideLoader();},uploadImage:function(){var that=this;this.showLoader();this.$('input[type="submit"]').trigger('click');this.$('iframe').load(function(){var data=$.parseJSON($(this).contents().find('pre').html()),imageId=data.id;that.model.set('header_image',imageId);that.showImage(data.url);that.$('#image-preview').addClass('with-image');that.hideLoader();});},showImage:function(url){this.$('#image-preview').css('background-image','url('+url+')');},showLoader:function(){this.$('#loader').show();},hideLoader:function(){this.$('#loader').hide();}});App.Models.PurchaseModel=App.Backbone.Model.extend({idAttribute:'txn_id'});App.Collections.PurchasesCollection=App.Backbone.Collection.extend({model:App.Models.PurchaseModel,url:apiUrl('myorders/'),parse:function(response){return response.data;}});App.Views.Purchases=App.Backbone.View.extend(_.extend({},{events:{'click .dropbox_saver_holder':'dropboxDownload'},initialize:function(){this.purchaseList=new App.Collections.PurchasesCollection();this.purchaseList.on('sync reset',this.renderMain,this);$.getScript('https://www.dropbox.com/static/api/1/dropins.js');},render:function(){baseView.setPageSize('wide');pageTitle('View your purchases!');var html=_.template(App.Templates.get('purchases'),{_:_});this.$el.html(html);this.purchaseList.fetch();return this;},renderMain:function(){this.$el.find('.loader').hide();if(this.purchaseList.length===0){this.$el.find('.no-purchases').show();}else{this.$el.find('.purchases-default').hide();this.purchaseList.forEach(this.renderOne,this);}
return this;},renderOne:function(model){var html=_.template(App.Templates.get('purchaseOne'),{_:_,model:model});this.$el.find('#purchases_list').append(html);},dropboxDownload:function(e){var bttn=$(e.currentTarget),server_url=bttn.data('href');_this=this;Dropbox.appKey='kqq0ygm2p4ep7fq';bttn.removeClass('normal').addClass('wait');$.ajax({type:'POST',url:server_url,error:function(){_this.dropboxError(bttn);},success:function(data){if(data.success){bttn.removeClass('wait').addClass('choose');bttn.attr('data-href',data.product_url);bttn.on('click',function(){var bttn_text=bttn.find('.button-choose'),options={files:[{'url':$(this).attr('data-href')}],success:function(){bttn_text.text('File saved');},progress:function(progress){progress=Math.ceil(progress*100);bttn_text.text('Saving: '+progress+'%');},error:function(){_this.dropboxError(bttn);}};Dropbox.save(options);return false;});}else{_this.dropboxError(bttn);}}});return false;},dropboxError:function(bttn){bttn.removeClass('normal choose wait').addClass('error');}}));ProductInfoModel=App.Backbone.Model.extend(_.extend({},{defaults:{title:'Product Title',price_str:'0.90$'}}));App.Models.Event=App.Backbone.Model.extend(_.extend({},{defaults:{event:'created_product',},initialize:function(){this.listenTo(this,'sync add',this.initializeSubModels);},initializeSubModels:function(){this.product=new ProductInfoModel(this.get('object'));}}));App.Collections.Feed=App.Backbone.Collection.extend(_.extend({},{firstItemCreatedAt:null,renderAfterLastItem:true,model:App.Models.Event,url:function(){var url='/user/feed/api/';if(this.last_item_created_at&&this.renderAfterLastItem){url+=('?before_created_at='+this.last_item_created_at);}
if(!this.renderAfterLastItem){if(this.firstItemCreatedAt){url+=('?after_created_at='+this.firstItemCreatedAt);}}
return url;},parse:function(response){var results=response.items;if(response.last_item_created_at){this.last_item_created_at=response.last_item_created_at;}
return results;}}));App.Models.UserProfile=App.Backbone.Model.extend({idAttribute:'merchant_name',defaults:{}});App.Collections.WhoToFollowList=App.Backbone.Collection.extend(_.extend({},{model:App.Models.UserProfile,url:function(){var url='/user/who_to_follow/';return url;},parse:function(response){return response.items;}}));App.Views.WhoToFollow=App.Backbone.View.extend({merchantCount:10,events:{'click .follow-merchant-icon':'follow','click #reload_merchants':'reloadMerchants'},initialize:function(){this.collection=new App.Collections.WhoToFollowList();this.listenTo(this.collection,'sync reset',this.renderAll);this.listenTo(this.collection,'remove-item',this.modelRemoved);this.collection.fetch({remove:false});},renderAll:function(){if(this.collection.length){this.$el.html(_.template(App.Templates.get('whoToFollow'),{}));this.collection.first(this.merchantCount).forEach(this.renderOne,this);}},renderOne:function(model){var html=_.template(App.Templates.get('whoToFollowItem'),{_:_,model:model});this.$el.find('#merchant_list').append(html);},modelRemoved:function(){if(this.$('.follow-merchant').length<this.merchantCount){this.collection.fetch({remove:false});}},follow:function(e){var that=this;var icon=$(e.currentTarget);var merchantName=icon.data('merchant');$.post('/user/subscribe/'+merchantName+'/',{source:'feed-right'},function(){icon.parents('.follow-merchant').fadeOut(200,function(){that.collection.remove(that.collection.where({merchant_name:merchantName}));$(this).remove();that.collection.trigger('remove-item');});App.Views.feed.loadRecentEvents();});},reloadMerchants:function(){this.collection.fetch();}});App.Views.Feed=App.Backbone.View.extend(_.extend({},App.Mixins.AppUiView,{isLoadingMore:false,needsResize:'',showEmptyFeed:true,initialize:function(){this.collection=new App.Collections.Feed();this.listenTo(this.collection,'sync reset',this.renderEvents);this.prepareContent();this.collection.fetch();_.bindAll(this,'detectScroll');},renderEvents:function(){App.Views.notificationView.updateUnreadCount();if(this.collection.renderAfterLastItem){this.renderAfterLastItem();}else{this.renderBeforeFirstItem();}
$(window).on('scroll.feedScrool',this.detectScroll);if(this.showEmptyFeed&&this.collection.length===0){this.renderEmptyFeed();}
this.showEmptyFeed=false;this.hideItemLoader();},renderBeforeFirstItem:function(){var that=this,feedItems=this.$('#feed_listing .feed-item');_.each(that.collection.last(that.collection.length).reverse(),function(model){var itemHtml=that.renderOne(model);that.insertOne(itemHtml,that.$('#feed_listing'),'before');});if(feedItems.length){this.collection.firstItemCreatedAt=this.$('#feed_listing').children('.feed-item').first().attr('id');}},renderAfterLastItem:function(){var that=this;this.collection.forEach(function(model){var itemHtml=that.renderOne(model);that.insertOne(itemHtml,that.$('#feed_listing'),'after');});this.isLoadingMore=false;},renderAll:function(){this.collection.forEach(this.renderOne,this);this.isLoadingMore=false;},renderOne:function(model){var preview=model.get('object').preview||'';if(model){this.$('.empty-feed-view').remove();}
return _.template(App.Templates.get('feedItem'),{_:_,model:model,hasImage:preview.indexOf('<img')===0});},render:function(){pageTitle('Feed');this.$(this.contentEl).html(App.Templates.get('feedListing'));this.whoToFollowView=new App.Views.WhoToFollow({el:this.$('#who_to_follow')});ga('set','dimension3','user-feed');lastVisitCookie('feed');this.feedLoader=this.$('#feed_loader');return this;},renderEmptyFeed:function(){pageTitle('Fill up your feed');this.$('#feed_listing').html(App.Templates.get('emptyFeedListing'));return this;},insertOne:function(element,parent,side){var newElement=$(element).hide();switch(side){case'after':newElement.appendTo(parent);break;case'before':newElement.prependTo(parent);break;}
newElement.fadeIn();},updateLoadMoreTimeout:function(){var that=this;clearInterval(this.fetchTimeout);this.fetchTimeout=setInterval(function(){that.loadMore();that.showItemLoader();},300);},loadMore:function(){this.collection.renderAfterLastItem=true;if(!this.isLoadingMore){this.isLoadingMore=true;clearInterval(this.fetchTimeout);this.collection.fetch();}},loadRecentEvents:function(){this.collection.renderAfterLastItem=false;this.collection.fetch();},detectScroll:function(){var lastFeedItem=this.$('.product-item').last();if(lastFeedItem.length&&lastFeedItem.visible(true)){this.updateLoadMoreTimeout();}},prepareContent:function(){baseView.$el.find('.my_account').hide();},showItemLoader:function(){this.feedLoader.show();},hideItemLoader:function(){this.feedLoader.fadeOut();},}));